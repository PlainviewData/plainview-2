function notify(a,b,c){$.notify({message:b,icon:c},{allow_dismiss:!1,position:"absolute",element:"#interface",type:a,placement:{from:"bottom",align:"left"},animate:{enter:"animated fadeInUp",exit:"animated fadeOutDown"},delay:2e3,timer:1e3})}function fetchResponses(a){$.ajax({type:"GET",url:"../../api/responses",data:a,success:function(a){fetchedResponses=a,loadResponseBrowser()}})}function loadResponseBrowser(){$("#responses").html(responseBrowser({responses:fetchedResponses}))}var g,svg,inner,zoom,currentDiscussionId,currentResponse,fetchedResponses=[],responseColors={subordinate:"#4286f4",concur:"#7af442",dissent:"#1d00ff",requestForClarification:"#d8d147",rejectPreviousArgumentType:"#ef0000",requestForFactualSubstantiation:"#848484"},argumentsToRespondTo=[],responses,discussion;$(document).ready(function(){function i(a,b){"samplediscussion"!==a?d3.json("../../api/discussions/id/"+a,function(a){responses=a.responses,discussion=a.discussion,b(responses,discussion)}):d3.json("../discussions/samplediscussion",function(a){responses=a.responses,discussion=a.discussion,b(responses,discussion)})}function j(f,g){function i(){c.graph().transition=function(a){return a.transition().duration(500)},c.nodes().forEach(function(b){var c=b.substring(1);void 0!==$("#t"+c).val()&&""!==$("#t"+c).val()&&(h[c].dataPersistence.writtenTitle=$("#t"+c).val()),void 0!==$("#r"+c).val()&&""!==$("#r"+c).val()&&(h[c].dataPersistence.writtenReply=$("#r"+c).val())});for(var a in h)if(h.hasOwnProperty(a)&&void 0!==c.node("n"+a)){var b;b=c.node("n"+a).label.indexOf("display:none")!==-1?"none":"inline-block";var g=$.grep(f,function(b){return b._id==a})[0];c.setNode("n"+a,{style:"stroke: #3563ad; stroke-width: 0.5px",id:"n"+a,labelType:"html",label:compiledResponseTemplate({templateData:{displayed:b,dataPersistence:h[a].dataPersistence,response:g,class:"originalResponse",responseTypeColor:"black"}}),class:"unselected-node"})}c.nodes().forEach(function(a){var b=c.node(a);b.rx=b.ry=3}),d3.select("svg g").call(d,c),e.selectAll(".node").on("mousedown",function(){mouseMovement&&(textSelected=!0,mouseMovement=!1),d3.event.stopPropagation()}),e.selectAll(".node").on("mousemove",function(){mouseMovement=!0}),e.selectAll(".node").on("click",function(a){currentResponse=a}),e.selectAll(".submit-reply-button").on("click",function(a){var b=d3.select(this.parentNode.parentNode).attr("id"),c=b.substring(b.indexOf("-")+1,b.length),e=($.grep(f,function(a){return a._id==c})[0],{});$.each($("#"+b).serializeArray(),function(a,b){e[b.name]=b.value}),l(e,c,!1,function(){k("n"+c),i()}),$("#r"+c).val(""),$("#t"+c).val(""),h[c].dataPersistence={writtenTitle:"",writtenReply:""}}),e.selectAll(".reply-button").on("click",function(a){var b="n"+d3.select(this.parentNode).attr("id");k(b),i()})}function j(a,b,d){console.log(a,b),h[a._id]="",f.push(a),h[a._id]={dataPersistence:{writtenTitle:"",writtenReply:""}},c.setNode("n"+a._id,{style:"stroke: #8a95a8; stroke-width: 0.5px",id:"n"+a._id,labelType:"html",label:compiledResponseTemplate({templateData:{displayed:"none",dataPersistence:h[a._id].dataPersistence,response:a,class:"originalResponse",responseTypeColor:"black"}}),class:"unselected-node"}),c.setEdge("n"+b,"n"+a._id,{style:"fill: none;stroke: #0084ff; stroke-width: 0.5px;",arrowhead:"undirected"}),i(),$("#r"+currentResponse).focus()}function k(a){c.node(a).label.indexOf("display:none")!==-1?c.node(a).label=c.node(a).label.replace("display:none","display:inline-block"):c.node(a).label=c.node(a).label.replace("display:inline-block","display:none")}function l(b,c,d,e){return Math.floor((Date.now()-localStorage.getItem("last_post"))/1e3)<=30&&null!==localStorage.getItem("last_post")?void notify("warning","Please wait 30 seconds after your last post","glyphicon glyphicon-alert"):void(d?$.ajax({type:"POST",url:"../addCitationToDiscussion",data:{discussionId:a,citation:JSON.stringify(b),relatedResponse:c,relationshipType:"dissent"},success:function(){notify("success","Replied to conversation","glyphicon glyphicon-ok-circle"),localStorage.setItem("last_post",Date.now()),e&&e()},error:function(a){400===a.status?notify("warning","You must be signed in to reply to this conversation","glyphicon glyphicon-alert"):429===a.status?notify("warning","Please wait 30 seconds after your last post","glyphicon glyphicon-alert"):notify("warning","Reply didn't go through. Please try again later","glyphicon glyphicon-alert")}}):$.ajax({type:"POST",url:"../../responses",data:{discussionId:a,responseTitle:b.title,responseText:b.text,created_by:"Striped Rhino",relatedResponse:c,relationshipType:"dissent"},success:function(a){notify("success","Replied to conversation","glyphicon glyphicon-ok-circle"),localStorage.setItem("last_post",Date.now()),e&&e()},error:function(a){400===a.status?notify("warning","You must be signed in to reply to this conversation","glyphicon glyphicon-alert"):429===a.status?notify("warning","Please wait 30 seconds after your last post","glyphicon glyphicon-alert"):notify("warning","Reply didn't go through. Please try again later","glyphicon glyphicon-alert")}}))}var h={};f.forEach(function(a){h[a._id]={dataPersistence:{writtenTitle:"",writtenReply:""}},console.log(g.relationships);g.relationships.filter(function(b){return void 0!==b[a._id]})[0][a._id].relationshipType;g.citations.indexOf(a._id)!==-1?c.setNode("n"+a._id,{style:"stroke: #4286f4; stroke-width: 0.5px",id:"n"+a._id,labelType:"html",label:compiledResponseTemplate({templateData:{displayed:"none",dataPersistence:h[a._id].dataPersistence,response:a,class:"citationResponse",responseTypeColor:"black"}}),class:"unselected-node "}):c.setNode("n"+a._id,{style:"stroke: #4286f4; stroke-width: 0.5px",id:"n"+a._id,labelType:"html",label:compiledResponseTemplate({templateData:{displayed:"none",dataPersistence:h[a._id].dataPersistence,response:a,class:"originalResponse",responseTypeColor:"black"}}),class:"unselected-node"}),g.relationships.slice(1,g.relationships.length).forEach(function(b){b.hasOwnProperty(a._id)&&c.setEdge("n"+b[a._id].relatedResponse,"n"+a._id,{style:"fill: none;stroke: #0084ff; stroke-width: 0.5px;",arrowhead:"undirected"})})}),b.on("newOriginalResponse",function(a){j(a.newResponse,a.relatedResponse,"originalResponse")}),b.on("newCitationResponse",function(a){j(a.citation,a.relatedResponse,"citationResponse")}),$("#responses").on("click",".cite-response",function(a){var b=$(a.target).closest(".thumbnail").attr("id"),c=$.grep(fetchedResponses,function(a){return a._id==b})[0];"n"+b!==currentResponse?(l(c,currentResponse.substring(1),!0),$("#responseModal").modal("hide")):1!==$(".alert","#"+b).length&&$(a.target).closest(".thumbnail").append("<div class='alert alert-warning'>Can't cite a response to itself</div>"),k(currentResponse)}),$("#responseBrowserSearchButton").on("click",function(a){a.preventDefault();var b={title:$("#responseTitle").val(),text:$("#responseKeywords").val()};fetchResponses(b)}),$("#responses").on("click",".use-title",function(a){var b=$(a.target).closest(".thumbnail").attr("id"),c=$.grep(fetchedResponses,function(a){return a._id==b})[0].title;$("#responseModal").modal("hide"),$("#t"+currentResponse.substring(1)).val(c)}),i(c),i(c)}var a=$(".discussionId").attr("id"),b=io();b.emit("viewingDiscussion",a);var c=(new dagreD3.graphlib.Graph).setGraph({}).setDefaultEdgeLabel(function(){return{}}),d=new dagreD3.render,e=d3.select("svg"),f=d3.select("svg g"),g=d3.behavior.zoom().on("zoom",function(){f.attr("transform","translate("+d3.event.translate+")scale("+d3.event.scale+")")});g.scale(1.5*g.scale()),e.call(g).on("dblclick.zoom",null),e.call(g).on("dblclick.zoom",null),e.call(g).call(g.event),fetchResponses(),i(a,j),startBloodhound();var h=new Clipboard(".urlButton");h.on("success",function(a){notify("info","Copied response id to clipboard!","glyphicon glyphicon-link")})});var mouseMovement;